<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	<sub-flow name="affluentManagementPapi-http-request"
		doc:id="4bf1b7dd-36af-42ff-b8c3-49f851ed73b5">
		<logger level="INFO" doc:name="Logger" doc:id="7833dbf5-a902-498f-8fb2-a914ee4f2ffc" message="Calling API with request config: [#[vars.requestConfig]]" />
		<until-successful
			maxRetries="#[vars.requestConfig.maxRetries default 0]"
			doc:name="Until Successful"
			doc:id="3f5f5437-84a1-4eed-b8ae-165f1124152d"
			millisBetweenRetries="#[vars.requestConfig.millisBetweenRetries default 0]">
			<try doc:name="Try" doc:id="6a931978-23c9-44d3-969d-fbc05e08d496">
				<http:request method="#[vars.requestConfig.method]"
					doc:name="Request" doc:id="3e2c5866-ab2b-4a91-bfdc-a48e3c08e09a"
					config-ref="affluentManagementPapi-http-request-config"
					path="#[vars.requestConfig.path]" sendCorrelationId="ALWAYS"
					correlationId="#[correlationId]"
					responseTimeout="#[vars.requestConfig.responseTimeout]">
					<http:body><![CDATA[#[%dw 2.0
output application/json indent=false
---
payload]]]></http:body>
					<http:headers><![CDATA[#[vars.requestConfig.headers]]]></http:headers>
			<http:uri-params><![CDATA[#[vars.requestConfig.uriParams]]]></http:uri-params>
			<http:query-params><![CDATA[#[vars.requestConfig.queryParams]]]></http:query-params>
		</http:request>
				<error-handler >
					<on-error-continue enableNotifications="true" logException="false" doc:name="On Error Continue" doc:id="9f5bce3d-db82-45c7-84e4-ed1e9c67be2c" type="${processApi.affluentManagement.notTransientErrors}">
						<logger level="ERROR" doc:name="Logger"
							doc:id="0491018d-705a-4777-8c69-c45bb2a58b6e"
							message="Failed to request external service. Will not retry. Error: #[error]" />
						<ee:transform doc:name="payload, httpStatus" doc:id="16d87085-4160-4b92-b6de-ae892850ea62" >
							<ee:message >
								<ee:set-payload ><![CDATA[error.errorMessage.payload default error]]></ee:set-payload>
							</ee:message>
							<ee:variables >
								<ee:set-variable variableName="httpStatus" ><![CDATA[error.errorMessage.payload.errorCode]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
					</on-error-continue>
					<on-error-propagate enableNotifications="true" logException="false" doc:name="On Error Propagate" doc:id="96ffdd16-9c87-4793-8048-ce857bae068b" >
						<logger level="ERROR" doc:name="Logger" doc:id="b2f9014e-e804-4efb-be3b-2dc3b34c34fe" message="Failed to request external service. Will retry. Error: #[error]"/>
					</on-error-propagate>
				</error-handler>
		</try>
		</until-successful>
	</sub-flow>
</mule>
